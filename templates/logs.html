{% extends "base.html" %}

{% block title %}Logs - Music Storage Manager{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-journal-text"></i> Operation Logs</h2>
    <div>
        <button class="btn btn-outline-primary" onclick="refreshLogs()">
            <i class="bi bi-arrow-clockwise"></i> Refresh
        </button>
        <button class="btn btn-outline-secondary" onclick="clearLogs()">
            <i class="bi bi-trash"></i> Clear Logs
        </button>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title">{{ log_stats.total_lines }}</h5>
                <p class="card-text text-muted">Total Log Lines</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title text-warning">{{ log_stats.warnings }}</h5>
                <p class="card-text text-muted">Warnings</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title text-danger">{{ log_stats.errors }}</h5>
                <p class="card-text text-muted">Errors</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title">{{ lines }}</h5>
                <p class="card-text text-muted">Showing Lines</p>
            </div>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <div class="row align-items-center">
            <div class="col">
                <h5 class="mb-0">Log Output</h5>
            </div>
            <div class="col-auto">
                <div class="input-group">
                    <select class="form-select" id="logLines" onchange="changeLinesCount()">
                        <option value="50" {{ 'selected' if lines == 50 else '' }}>50 lines</option>
                        <option value="100" {{ 'selected' if lines == 100 else '' }}>100 lines</option>
                        <option value="200" {{ 'selected' if lines == 200 else '' }}>200 lines</option>
                        <option value="500" {{ 'selected' if lines == 500 else '' }}>500 lines</option>
                    </select>
                    <input type="text" class="form-control" id="searchLogs" placeholder="Search logs..." onkeyup="filterLogs()">
                </div>
            </div>
        </div>
    </div>
    <div class="card-body p-0">
        <div id="logContainer" style="height: 600px; overflow-y: auto; background-color: #f8f9fa;">
            <div class="p-3">
                {% if logs %}
                    {% for log in logs %}
                    <div class="log-line mb-1 p-2 {{ 'bg-danger text-white' if 'ERROR' in log else 'bg-warning text-dark' if 'WARN' in log else 'bg-light' }}"
                         style="font-family: monospace; font-size: 0.9rem; border-radius: 3px;">
                        <span class="log-content">{{ log }}</span>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="text-center text-muted py-5">
                        <i class="bi bi-journal-x" style="font-size: 3rem;"></i>
                        <p class="mt-3">No logs available</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    <div class="card-footer">
        <div class="row align-items-center">
            <div class="col">
                <small class="text-muted">
                    <i class="bi bi-info-circle"></i>
                    Auto-refresh every 30 seconds. Use search to filter log entries.
                </small>
            </div>
            <div class="col-auto">
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="autoRefresh" checked>
                    <label class="form-check-label" for="autoRefresh">
                        Auto-refresh
                    </label>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Log Details Modal -->
<div class="modal fade" id="logDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Log Entry Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <pre id="logDetailsContent" style="background-color: #f8f9fa; padding: 1rem; border-radius: 5px; white-space: pre-wrap;"></pre>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let autoRefreshInterval;

function refreshLogs() {
    const lines = document.getElementById('logLines').value;
    window.location.href = `{{ url_for('logs') }}?lines=${lines}`;
}

function changeLinesCount() {
    refreshLogs();
}

async function clearLogs() {
    if (confirm('Are you sure you want to clear all logs? This will create a backup and clear the current log file.')) {
        try {
            const response = await fetch('/api/clear-logs', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            const result = await response.json();

            if (result.status === 'success') {
                alert('Logs cleared successfully! A backup was created.');
                refreshLogs();
            } else {
                alert('Failed to clear logs: ' + result.message);
            }
        } catch (error) {
            alert('Error clearing logs: ' + error.message);
        }
    }
}

function filterLogs() {
    const searchTerm = document.getElementById('searchLogs').value.toLowerCase();
    const logLines = document.querySelectorAll('.log-line');

    logLines.forEach(line => {
        const content = line.querySelector('.log-content').textContent.toLowerCase();
        if (content.includes(searchTerm) || searchTerm === '') {
            line.style.display = '';
        } else {
            line.style.display = 'none';
        }
    });
}

function showLogDetails(logContent) {
    document.getElementById('logDetailsContent').textContent = logContent;
    new bootstrap.Modal(document.getElementById('logDetailsModal')).show();
}

// Auto-refresh functionality
function startAutoRefresh() {
    if (document.getElementById('autoRefresh').checked) {
        autoRefreshInterval = setInterval(async () => {
            try {
                const lines = document.getElementById('logLines').value;
                const response = await fetch(`/api/logs?lines=${lines}`);
                const data = await response.json();

                updateLogDisplay(data.logs);
                updateLogStats(data.stats);
            } catch (error) {
                console.error('Auto-refresh failed:', error);
            }
        }, 30000); // 30 seconds
    }
}

function stopAutoRefresh() {
    if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
    }
}

function updateLogDisplay(logs) {
    const container = document.getElementById('logContainer');
    const scrolledToBottom = container.scrollTop + container.clientHeight >= container.scrollHeight - 10;

    let html = '<div class="p-3">';
    if (logs.length > 0) {
        logs.forEach(log => {
            const logClass = log.includes('ERROR') ? 'bg-danger text-white' :
                           log.includes('WARN') ? 'bg-warning text-dark' : 'bg-light';

            html += `<div class="log-line mb-1 p-2 ${logClass}"
                           style="font-family: monospace; font-size: 0.9rem; border-radius: 3px;"
                           onclick="showLogDetails('${log.replace(/'/g, '\\\'')}')"
                           style="cursor: pointer;">
                        <span class="log-content">${log}</span>
                     </div>`;
        });
    } else {
        html += `<div class="text-center text-muted py-5">
                    <i class="bi bi-journal-x" style="font-size: 3rem;"></i>
                    <p class="mt-3">No logs available</p>
                 </div>`;
    }
    html += '</div>';

    container.innerHTML = html;

    // Maintain scroll position or scroll to bottom if was at bottom
    if (scrolledToBottom) {
        container.scrollTop = container.scrollHeight;
    }

    // Reapply search filter if active
    const searchTerm = document.getElementById('searchLogs').value;
    if (searchTerm) {
        filterLogs();
    }
}

function updateLogStats(stats) {
    // Update stats display if needed
    // This would update the stats cards at the top
}

// Event listeners
document.getElementById('autoRefresh').addEventListener('change', function() {
    if (this.checked) {
        startAutoRefresh();
    } else {
        stopAutoRefresh();
    }
});

// Start auto-refresh on page load
document.addEventListener('DOMContentLoaded', function() {
    startAutoRefresh();

    // Scroll to bottom on initial load
    const container = document.getElementById('logContainer');
    container.scrollTop = container.scrollHeight;

    // Add click handlers to existing log lines for details modal
    document.querySelectorAll('.log-line').forEach(line => {
        line.style.cursor = 'pointer';
        line.addEventListener('click', function() {
            const content = this.querySelector('.log-content').textContent;
            showLogDetails(content);
        });
    });
});

// Cleanup on page unload
window.addEventListener('beforeunload', function() {
    stopAutoRefresh();
});
</script>
{% endblock %}