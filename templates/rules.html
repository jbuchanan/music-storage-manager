{% extends "base.html" %}

{% block title %}Rules Management - Music Storage Manager{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-list-check"></i> Rules Management</h2>
    <div>
        <button class="btn btn-success" onclick="addRule()">
            <i class="bi bi-plus"></i> Add Rule
        </button>
        <button class="btn btn-primary" onclick="saveRules()">
            <i class="bi bi-floppy"></i> Save Changes
        </button>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <div class="row align-items-center">
            <div class="col">
                <h5 class="mb-0">Storage Rules</h5>
            </div>
            <div class="col-auto">
                <input type="text" class="form-control" id="searchRules" placeholder="Search rules..." onkeyup="filterRules()">
            </div>
        </div>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0" id="rulesTable">
                <thead class="table-light">
                    <tr>
                        <th style="width: 40%">Source Path</th>
                        <th style="width: 15%">Target</th>
                        <th style="width: 20%">Destination Subpath</th>
                        <th style="width: 15%">Mode</th>
                        <th style="width: 10%">Actions</th>
                    </tr>
                </thead>
                <tbody id="rulesTableBody">
                    {% for rule in rules %}
                    <tr data-rule-index="{{ loop.index0 }}">
                        <td>
                            <input type="text" class="form-control form-control-sm"
                                   value="{{ rule.source }}"
                                   data-field="source"
                                   title="{{ rule.source }}">
                        </td>
                        <td>
                            <select class="form-select form-select-sm" data-field="target">
                                <option value="SSD" {{ 'selected' if rule.target.upper() == 'SSD' else '' }}>SSD</option>
                                <option value="NAS" {{ 'selected' if rule.target.upper() == 'NAS' else '' }}>NAS</option>
                                <option value="Local" {{ 'selected' if rule.target.upper() == 'LOCAL' else '' }}>Local</option>
                            </select>
                        </td>
                        <td>
                            <input type="text" class="form-control form-control-sm"
                                   value="{{ rule.subpath }}"
                                   data-field="subpath"
                                   placeholder="Auto-generated if empty">
                        </td>
                        <td>
                            <select class="form-select form-select-sm" data-field="mode">
                                <option value="move" {{ 'selected' if rule.mode == 'move' else '' }}>move</option>
                                <option value="copy" {{ 'selected' if rule.mode == 'copy' else '' }}>copy</option>
                            </select>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteRule({{ loop.index0 }})" title="Delete Rule">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    <div class="card-footer text-muted">
        <small>
            <i class="bi bi-info-circle"></i>
            <strong>Mode:</strong> 'move' creates symlinks after moving, 'copy' creates backups only.
            <strong>Targets:</strong> SSD for performance-critical libraries, NAS for large archives, Local to keep in place.
        </small>
    </div>
</div>

<!-- Add Rule Modal -->
<div class="modal fade" id="addRuleModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Rule</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addRuleForm">
                    <div class="mb-3">
                        <label for="newSource" class="form-label">Source Path</label>
                        <input type="text" class="form-control" id="newSource"
                               placeholder="/path/to/source or $HOME/relative/path" required>
                        <div class="form-text">Use $HOME for user directory or absolute paths</div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <label for="newTarget" class="form-label">Target</label>
                            <select class="form-select" id="newTarget" required>
                                <option value="">Select target...</option>
                                <option value="SSD">SSD (Fast access)</option>
                                <option value="NAS">NAS (Network storage)</option>
                                <option value="Local">Local (Keep in place)</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="newMode" class="form-label">Mode</label>
                            <select class="form-select" id="newMode" required>
                                <option value="move">move (migrate + symlink)</option>
                                <option value="copy">copy (backup only)</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-3 mt-3">
                        <label for="newSubpath" class="form-label">Destination Subpath (optional)</label>
                        <input type="text" class="form-control" id="newSubpath"
                               placeholder="Leave empty to use folder name">
                        <div class="form-text">Subpath under the target root directory</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitNewRule()">Add Rule</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let rulesData = {{ rules | tojson }};

function addRule() {
    new bootstrap.Modal(document.getElementById('addRuleModal')).show();
}

function submitNewRule() {
    const source = document.getElementById('newSource').value;
    const target = document.getElementById('newTarget').value;
    const subpath = document.getElementById('newSubpath').value;
    const mode = document.getElementById('newMode').value;

    if (!source || !target || !mode) {
        alert('Please fill in all required fields');
        return;
    }

    const newRule = {
        source: source,
        target: target,
        subpath: subpath,
        mode: mode
    };

    rulesData.push(newRule);
    addRuleToTable(newRule, rulesData.length - 1);

    // Clear form and close modal
    document.getElementById('addRuleForm').reset();
    bootstrap.Modal.getInstance(document.getElementById('addRuleModal')).hide();
}

function addRuleToTable(rule, index) {
    const tbody = document.getElementById('rulesTableBody');
    const row = document.createElement('tr');
    row.setAttribute('data-rule-index', index);

    row.innerHTML = `
        <td>
            <input type="text" class="form-control form-control-sm"
                   value="${rule.source}"
                   data-field="source"
                   title="${rule.source}">
        </td>
        <td>
            <select class="form-select form-select-sm" data-field="target">
                <option value="SSD" ${rule.target === 'SSD' ? 'selected' : ''}>SSD</option>
                <option value="NAS" ${rule.target === 'NAS' ? 'selected' : ''}>NAS</option>
                <option value="Local" ${rule.target === 'Local' ? 'selected' : ''}>Local</option>
            </select>
        </td>
        <td>
            <input type="text" class="form-control form-control-sm"
                   value="${rule.subpath}"
                   data-field="subpath"
                   placeholder="Auto-generated if empty">
        </td>
        <td>
            <select class="form-select form-select-sm" data-field="mode">
                <option value="move" ${rule.mode === 'move' ? 'selected' : ''}>move</option>
                <option value="copy" ${rule.mode === 'copy' ? 'selected' : ''}>copy</option>
            </select>
        </td>
        <td>
            <button class="btn btn-sm btn-outline-danger" onclick="deleteRule(${index})" title="Delete Rule">
                <i class="bi bi-trash"></i>
            </button>
        </td>
    `;

    tbody.appendChild(row);
}

function deleteRule(index) {
    if (confirm('Are you sure you want to delete this rule?')) {
        rulesData.splice(index, 1);
        refreshTable();
    }
}

function refreshTable() {
    const tbody = document.getElementById('rulesTableBody');
    tbody.innerHTML = '';

    rulesData.forEach((rule, index) => {
        addRuleToTable(rule, index);
    });
}

async function saveRules() {
    // Collect current data from table
    const rows = document.querySelectorAll('#rulesTableBody tr');
    const updatedRules = [];

    rows.forEach((row, index) => {
        const source = row.querySelector('[data-field="source"]').value;
        const target = row.querySelector('[data-field="target"]').value;
        const subpath = row.querySelector('[data-field="subpath"]').value;
        const mode = row.querySelector('[data-field="mode"]').value;

        updatedRules.push({ source, target, subpath, mode });
    });

    try {
        const response = await fetch('/api/rules', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(updatedRules)
        });

        const result = await response.json();

        if (result.status === 'success') {
            alert('Rules saved successfully!');
            rulesData = updatedRules;
        } else {
            alert('Error saving rules: ' + result.message);
        }
    } catch (error) {
        alert('Error saving rules: ' + error.message);
    }
}

function filterRules() {
    const searchTerm = document.getElementById('searchRules').value.toLowerCase();
    const rows = document.querySelectorAll('#rulesTableBody tr');

    rows.forEach(row => {
        const source = row.querySelector('[data-field="source"]').value.toLowerCase();
        const target = row.querySelector('[data-field="target"]').value.toLowerCase();

        if (source.includes(searchTerm) || target.includes(searchTerm)) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}

// Update rulesData when table inputs change
document.addEventListener('change', function(e) {
    if (e.target.matches('#rulesTableBody input, #rulesTableBody select')) {
        const row = e.target.closest('tr');
        const index = parseInt(row.getAttribute('data-rule-index'));
        const field = e.target.getAttribute('data-field');

        if (rulesData[index]) {
            rulesData[index][field] = e.target.value;
        }
    }
});
</script>
{% endblock %}